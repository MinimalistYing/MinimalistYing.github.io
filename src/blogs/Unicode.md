# Unicode & JavaScript

## å¼•å­
è®¡ç®—æœºçš„ä¸–ç•Œé‡Œåªæœ‰ 0 å’Œ 1ï¼Œå›¾ç‰‡ / æ–‡å­— / è§†é¢‘ç­‰åœ¨è®¡ç®—æœºä¸Šå­˜å‚¨ä¼ è¾“éƒ½éœ€è¦å…ˆé€šè¿‡æŸç§è§„åˆ™è¿›è¡Œè½¬åŒ–ã€‚  

æ—©æœŸçš„ ASCII (American Standard Code for Information Interchange) å®šä¹‰äº† 128 ä¸ªå¸¸è§å­—ç¬¦ã€‚ä¾‹å¦‚è‹±æ–‡å­—æ¯ `a` å¯¹åº”çš„æ•°å­—æ˜¯ `97` å¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯ `0110 0001`ã€‚  

å¦‚æœä¸–ç•Œä¸Šåªæœ‰è‹±æ–‡ä¸€ç§è¯­è¨€ï¼Œå¯èƒ½å°±ä¸ä¼šæœ‰åé¢çš„æ•…äº‹äº†ã€‚ä½†å¾ˆå¯æƒœï¼Œåœ°çƒä¸Šæ¯ä¸ªå›½å®¶éƒ½æœ‰ç€å„è‡ªçš„è¯­è¨€æ–‡å­—ï¼Œä»…ä¸­æ–‡å°±æœ‰ç€è¶…è¿‡ 3000 ä¸ªçš„å¸¸ç”¨å­—ç¬¦ï¼Œå½“è®¡ç®—æœºè¢«å‡ºå£è‡³ä¸–ç•Œå„å›½æ—¶ï¼ŒASCII å·²ç»ä¸è¶³ä»¥æ»¡è¶³äººä»¬çš„éœ€æ±‚äº†ã€‚  

ä¸­å›½äººå½“ç„¶å¸Œæœ›è®¡ç®—æœºèƒ½å±•ç¤ºå¤„ç†æ±‰å­—ï¼Œäºæ˜¯å°±åˆ›é€ äº† GB2312 / GB18030 ç­‰ä¸­æ–‡å­—ç¬¦é›†ã€‚é‚£ä¹ˆéæ´²åŒèƒå½“ç„¶å¯èƒ½ä¹Ÿæœ‰è‡ªå·±çš„ XXX å­—ç¬¦é›†ã€‚æƒ³è±¡ä¸€ä¸‹å¦‚æœæ¯ä¸ªå›½å®¶çš„æ–‡å­—éƒ½æœ‰ç€è‡ªå·±çš„å­—ç¬¦é›†ï¼Œé‚£ä¹ˆç¢°åˆ°å†²çªæ—¶è®¡ç®—æœºåˆæ€ä¹ˆèƒ½çŸ¥é“åˆ°åº•è¯¥ç”¨å“ªä¸ªå­—ç¬¦å‘¢ã€‚  

å¥½åœ¨ï¼Œæœ‰è¿™ä¹ˆä¸€ç¾¤æœ‰å¿—ä¹‹å£«ï¼Œè‡´åŠ›äºå°†å…¨çƒæ‰€æœ‰çš„å­—ç¬¦æ•´ç†åˆ°åŒä¸€ä¸ªå­—ç¬¦é›†ã€‚è¿™å°±æ˜¯ Unicode ï¼Œç”± Unicode Consortium è´Ÿè´£ç»´æŠ¤ï¼Œè¿™é‡Œæ˜¯ä»–ä»¬çš„ [å®˜æ–¹ç½‘ç«™](https://home.unicode.org/)ã€‚

## Unicode
é¦–å…ˆè¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ Unicode æ˜¯å­—ç¬¦é›†ï¼Œæ‰€ä»¥å®ƒçš„å·¥ä½œæ˜¯å°†ä¸–ç•Œä¸Šæ‰€æœ‰çš„æ–‡å­—ç¬¦å·å¯¹åº”åˆ°ç›¸åº”çš„ç ç‚¹ï¼ˆCode Point ï¼‰ä¸Šï¼Œè€Œå¦‚ä½•å°†å¯¹åº”çš„ç ç‚¹è½¬åŒ–ä¸º 0 / 1 è®©è®¡ç®—æœºå­˜å‚¨æ˜¯å­—ç¬¦ç¼–ç ï¼ˆUTF-8 / UTF-16 ç­‰ï¼‰çš„å·¥ä½œã€‚  

ç ç‚¹é€šä¿—æ¥è®²å°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæœ€æ–°çš„ Unicode æ ‡å‡†æ”¯æŒä¸€å…± 143,859 ä¸ªå­—ç¬¦ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½ä¸ä¸€ä¸ªç ç‚¹ä¸€ä¸€å¯¹åº”ã€‚å› ä¸ºå­—ç¬¦æ•°å¤ªå¤šï¼Œæ‰€ä»¥ä¸ºäº†å°†ä¸åŒçš„å­—ç¬¦åšä¸€ä¸ªå¤§æ¦‚çš„åŒºåˆ†ï¼ŒUnicode å°†ç¼–ç åˆ†æˆäº† 17 ä¸ªå¹³é¢ï¼ˆPlaneï¼‰ï¼Œæ¯å¹³é¢æ‹¥æœ‰65536ï¼ˆå³2^16ï¼‰ä¸ªç ç‚¹ã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯ BMPï¼ˆBasic Multilingual Planeï¼‰ï¼Œè¯¥å¹³é¢åŒ…å«äº† U+0000 - U+FFFF åŒºé—´å†…çš„ç ç‚¹ã€‚

## UTF-8 / UTF-16 / UTF-32
UTF-8 æ˜¯ä½¿ç”¨ä¸€è‡³å…­ä¸ªå­—èŠ‚çš„å˜é•¿ç¼–ç ï¼š
```
U+ 0000 ~ U+ 007F:  0XXXXXXX
U+ 0080 ~ U+ 07FF:  110XXXXX 10XXXXXX
U+ 0800 ~ U+ FFFF:  1110XXXX 10XXXXXX 10XXXXXX
U+10000 ~ U+10FFFF: 11110XXX 10XXXXXX 10XXXXXX 10XXXXXX

// ä¸‹é¢é€šè¿‡å‡ ä¸ªä¾‹å­æ¥é˜è¿° UTF-8 ç¼–ç çš„è¿‡ç¨‹

// A U+ 0041
// åœ¨ U+ 0000 ~ U+ 007F èŒƒå›´
// é¦–å…ˆå°† U+ 0041 ç”¨äºŒè¿›åˆ¶è¡¨ç¤º
10 1001
// å¾ˆç®€å•å°†äºŒè¿›åˆ¶ç›´æ¥å¡«å…¥ï¼Œé«˜ä½è¡¥é›¶åˆ™èƒ½å¾—åˆ°ç›¸åº”ç¼–ç 
0XXXXXXX
00101001

// çŸ¥ U+ 77E5
// åœ¨ U+ 0800 ~ U+ FFFF èŒƒå›´
// é¦–å…ˆå°† U+ 77E5 ç”¨äºŒè¿›åˆ¶è¡¨ç¤º
111 0111 1110 0101
// å°†äºŒè¿›åˆ¶å¡«å…¥ï¼Œé«˜ä½è¡¥é›¶
1110XXXX 10XXXXXX 10XXXXXX
11100111 10011111 10100101
```
UTF-16 æ˜¯ä½¿ç”¨äºŒä¸ªæˆ–å››ä¸ªå­—èŠ‚çš„å˜é•¿ç¼–ç ï¼ˆPs: UTF-16 æ˜¯ UCS-2 çš„è¶…é›†ï¼Œä¿©è€…åœ¨ BMP èŒƒå›´å†…æ˜¯ç­‰ä»·çš„ï¼ŒUCS-2 å›ºå®šç”¨ä¿©ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç æ‰€ä»¥ä»…æ”¯æŒ BMP èŒƒå›´å†…çš„ 65536 ä¸ªå­—ç¬¦ï¼‰:
```
// A U+ 0041
// äºŒè¿›åˆ¶
10 1001
// é«˜ä½è¡¥é›¶
00000000 00101001

// çŸ¥ U+ 77E5
// äºŒè¿›åˆ¶
111 0111 1110 0101
// é«˜ä½è¡¥é›¶
01110111 11100101

// ğŒ† U+ 1D306
// äºŒè¿›åˆ¶
1 1101 0011 0000 0110
// éœ€è¦å››ä¸ªå­—èŠ‚ï¼Œè¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒå¤æ‚çš„è®¡ç®—è¿‡ç¨‹ï¼Œå…¬å¼å¦‚ä¸‹
H = Math.floor((c-0x10000) / 0x400)+0xD800

L = (c - 0x10000) % 0x400 + 0xDC00
// æœ€åç»“æœæ˜¯
1101 1000 0011 0100 1101 1111 0000 0110
```
å¦å¤–è¿˜æœ‰ UTF-32ï¼Œå®šé•¿å››å­—èŠ‚ï¼Œæ‰€ä»¥ç›´æ¥å°†ç ç‚¹è½¬ä¸ºäºŒè¿›åˆ¶é«˜ä½è¡¥é›¶åå­˜å‚¨å³å¯ã€‚ç”±äºè¿‡äºæµªè´¹ç©ºé—´ï¼Œå› ä¸ºæ‰€æœ‰çš„å­—ç¬¦éƒ½éœ€è¦å››ä¸ªå­—èŠ‚æ¥å­˜å‚¨ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šè§åˆ°è¿™ç§ç¼–ç æ–¹å¼ã€‚

å†æ¥è®²è®² UTF-8 å’Œ UTF-16 çš„ä¼˜ç¼ºç‚¹ï¼Œç”±äºå®Œå…¨å…¼ç”¨ ASCII ç¼–ç æ‰€ä»¥ UTF-8 å¯¹è‹±æ–‡ä¸–ç•Œç‰¹åˆ«å‹å¥½ï¼Œåªéœ€è¦ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥å¯¹å‡ ä¹æ‰€æœ‰çš„æ–‡å­—è¿›è¡Œç¼–ç ï¼Œæ˜¯ä¸€ç§éå¸¸èŠ‚çœç©ºé—´å’Œæµé‡çš„æ–¹å¼ã€‚ä½†æ˜¯å¯¹äºä¸­æ–‡æ¥è¯´å°±ä¸ä¸€æ ·äº†ï¼Œå¤§éƒ¨åˆ†ä¸­æ–‡å­—ç¬¦ç”¨ UTF-8 éœ€è¦ä¸‰ä¸ªå­—èŠ‚æ¥ç¼–ç è€Œç”¨ UTF-16 åˆ™åªéœ€è¦ä¿©ä¸ªå­—èŠ‚ã€‚

å¦å¤–ï¼Œåœ¨ Web çš„ä¸–ç•Œä¸­åŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡ UTF-8 è¿›è¡Œç¼–ç ï¼ŒåŒ…æ‹¬ JSON / HTML ç­‰ç­‰ã€‚å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä»¥åŠ Windows ç³»ç»Ÿéƒ½æ˜¯ç”¨çš„ UTF-16 ç¼–ç ï¼Œä½† Unix ç³»ç»Ÿçš„é»˜è®¤ç¼–ç ä¸º UTF-8ã€‚  

æ€»ç»“å°±æ˜¯è‹±è¯­ä¸–ç•Œçš„äººä¼šæ›´å–œæ¬¢ UTF-8 å› ä¸ºå ç”¨ç©ºé—´å°‘ï¼Œç¼–ç æ–¹ä¾¿ï¼Œä¸”æ²¡æœ‰å­—èŠ‚åºçš„é—®é¢˜ã€‚ä½†æ˜¯éè‹±è¯­ä¸–ç•Œçš„äººå¯èƒ½ä¼šå€¾å‘äºä½¿ç”¨ UTF-16 ã€‚ä½†ä»ç°åœ¨çš„è§’åº¦æ¥çœ‹ï¼Œä¸è®ºæ˜¯ç½‘ç»œä¼ è¾“è¿˜æ˜¯æœ¬åœ°å­˜å‚¨ï¼Œæ–‡å­—å ç”¨çš„ç©ºé—´å¯è°“å°‘ä¹‹åˆå°‘ï¼Œæ‰€ä»¥ç°åœ¨è€ƒè™‘ç¼–ç æ–¹å¼è¿˜éœ€è¦å…³å¿ƒç©ºé—´æµªè´¹ä¸å¦å—ï¼Ÿä¸ºäº†é¿å…é‚£äº›å› ä¸ºç¼–ç æ–¹å¼ä¸åŒå¯¼è‡´çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ç»Ÿä¸€ä¸€ä¸‹ä¸–ç•Œä¸Šçš„ç¼–ç æ–¹å¼å‘¢ï¼Ÿå®é™…ä¸Šç°åœ¨çš„ Windows å·²ç»[å¼€å§‹æ”¯æŒä½¿ç”¨ UTF-8 äº†](https://docs.microsoft.com/en-us/windows/uwp/design/globalizing/use-utf8-code-page)ã€‚

## å¦‚ä½•ä½¿ç”¨æ­£åˆ™åŒ¹é…ä¸­æ–‡å­—ç¬¦
å¦‚æœä½ è¯•å›¾åœ¨ç™¾åº¦ä¸Šæ£€ç´¢ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæ‰¾åˆ° `/[\u4e00-\u9fff]/` æˆ–è€… `/[\u4e00-\u9fa5]/` è¿™ä¿©ä¸ªæ¯”è¾ƒå¸¸è§çš„ç­”æ¡ˆã€‚ä½†å®é™…ä¸Šè¿™ä¿©ä¸ªæ­£åˆ™éƒ½ä¸èƒ½è¯´å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºå®ƒä»¬éƒ½åªè€ƒè™‘åˆ°äº† [CJK Unified Ideographs U+4e00 ~	U+9fff](https://unicode-table.com/cn/#cjk-unified-ideographs) è¿™ä¸€ä¸ª Block ä¸‹çš„å­—ç¬¦ã€‚  

ä½†è¿˜æœ‰å¾ˆå¤šä¸å¤ªå¸¸è§çš„ä¸­æ–‡å­—ç¬¦æ˜¯å…¶å®ƒ Block ä¸‹çš„ï¼Œä¾‹å¦‚ [CJK Unified Ideographs Extension A](https://unicode-table.com/cn/#cjk-unified-ideographs-extension-a) ä¸­å°±åŒ…å«äº†å¾ˆå¤šä¸­æ–‡ç”Ÿåƒ»å­—ç¬¦ã€‚  

Ps: CJK characters æŒ‡çš„æ˜¯ä¸­æ—¥éŸ©ä¸‰å›½çš„å­—ç¬¦ï¼Œç”±äºä¸‰å›½çš„æ–‡å­—æœ‰å¾ˆå¤šç±»ä¼¼ä¹‹å¤„ï¼Œæ‰€ä»¥åœ¨ Unicode ä¸­é€šå¸¸éƒ½è¢«å½’ä¸ºåŒä¸€ç±»ã€‚  

æ‰€ä»¥å¦‚æœéè¦å†™å‡ºä¸€ä¸ªå®Œå…¨æ­£ç¡®çš„æ­£åˆ™å¯èƒ½éœ€è¦æŠŠ Unicode ä¸­æ‰€æœ‰å¯¹åº”çš„ä¸­æ–‡å­—ç¬¦ç¼–ç æ‰¾å‡ºæ¥ï¼ˆä¸ªäººå»ºè®®æ˜¯æ‰¾å‡ºæ‰€æœ‰ CJK çš„æ‰€å± Block ä¹Ÿå°±ç¡æŠŠæ—¥è¯­éŸ©è¯­ä¹ŸåŒ…å«è¿›å»ï¼‰ï¼Œä½†å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨ `/[\u4e00-\9fff]/` åº”è¯¥å°±è¶³å¤Ÿäº†ã€‚

## JavaScript ä¸­çš„å­—ç¬¦ç¼–ç 
æ—©æœŸ JavaScript é‡‡ç”¨çš„ç¼–ç æ–¹å¼æ˜¯ USC-2ï¼Œä½†ç°åœ¨åè®®ä¸­æåˆ°çš„åªæœ‰ UTF-16ï¼š
> The String type is the set of all ordered sequences of zero or more 16-bit unsigned integer values (â€œelementsâ€) up to a maximum length of 253 - 1 elements. The String type is generally used to represent textual data in a running ECMAScript program, in which case each element in the String is treated as a UTF-16 code unit value. Each element is regarded as occupying a position within the sequence. These positions are indexed with nonnegative integers. The first element (if any) is at index 0, the next element (if any) at index 1, and so on. The length of a String is the number of elements (i.e., 16-bit values) within it. The empty String has length zero and therefore contains no elements.

åœ¨ ES6 å‡ºæ¥ä¹‹å‰ JavaScript å¤„ç† BMP ä¹‹å¤–çš„å­—ç¬¦ï¼ˆä¹Ÿå°±æ˜¯éœ€è¦å››ä¸ªå­—èŠ‚å­˜å‚¨çš„å­—ç¬¦ï¼‰ä¼šç¢°åˆ°ä¸å°‘è®©äººè¿·æƒ‘çš„é—®é¢˜ã€‚ES6 å°½å¯èƒ½çš„è¿›è¡Œäº†ä¸€äº›ä¿®æ­£ï¼Œä½†æ˜¯å‡ºäºå‰å‘å…¼å®¹çš„è€ƒè™‘ï¼Œå¾ˆå¤š API ä»ç„¶åªèƒ½ç»´æŒé”™è¯¯çš„è¡Œä¸ºã€‚

ä¾‹å¦‚ `String.prototype.length` ç»Ÿè®¡çš„æ˜¯å­—ç¬¦ä¸²ç”¨äº†å¤šå°‘ä¸ª 16-bit è¿›è¡Œç¼–ç ï¼ˆ16bitï¼‰ã€‚ä»ä¸Šæ–‡ä¸­å…³äº UTF-16 çš„çŸ¥è¯†ä¸éš¾çœ‹å‡ºå¯¹äº Unicode BMP èŒƒå›´å¤–çš„å­—ç¬¦è¿™ç§ç»Ÿè®¡æ–¹å¼å¾ˆæ˜æ˜¾æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºä¸€ä¸ªå­—ç¬¦ä¼šç”¨åˆ° 4 ä¸ªå­—èŠ‚ä¹Ÿå°±æ˜¯ 32-bit æ¥ç¼–ç ï¼š
> This property returns the number of code units in the string. UTF-16, the string format used by JavaScript, uses a single 16-bit code unit to represent the most common characters, but needs to use two code units for less commonly-used characters, so it's possible for the value returned by length to not match the actual number of characters in the string

æ‰€ä»¥ä¼šå‡ºç°å­—ç¬¦ä¸²çš„ `length` å¤§äºå®é™…å‡ºç°å­—ç¬¦æ•°çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š
```js
// U+ 1D306
'ğŒ†'.length // 2

/* è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ */

// å› ä¸º Array.prototype.from æ˜¯ ES6 å¼•å…¥çš„æ–° APIï¼Œæ‰€ä»¥å·²ç»ä¿®å¤äº†ç›¸å…³é—®é¢˜
Array.from('ğŒ†').length // 1
```

å†ä¾‹å¦‚ `String.prototype.split` ä¼šäº§ç”Ÿä¹±ç ï¼š
```js
'ğŒ†'.split('') // ["ï¿½", "ï¿½"]

/* è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ */

Array.from('ğŒ†') // ["ğŒ†"]
```

å†ä¾‹å¦‚ `String.prototype.charCodeAt` ä»¥åŠ `String.fromCharCode` ç¢°åˆ° BMP å¤–çš„å­—ç¬¦éƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¿˜æ˜¯æ‹¿ `ğŒ†` æ¥ä¸¾ä¾‹ï¼š
```js
// ğŒ† çš„ç ç‚¹æ˜¯ U+ 1D306 å¯¹åº”çš„åè¿›åˆ¶æ•°å­— 119558
'ğŒ†'.charCodeAt(0) // 55348 = = ! è¿™ä¸ªç ç‚¹å¯¹åº”çš„ä¸æ˜¯ ğŒ†

String.fromCharCode(119558) // íŒ† = = ! è¯¥å­—ç¬¦çš„æ­£ç¡®ç ç‚¹æ˜¯ 54022

// å®é™…ä¸Šä¹Ÿæ˜¯èƒ½æ­£å¸¸å·¥ä½œçš„ï¼Œåªæ˜¯éœ€è¦ä¿©æ­¥ï¼Œå½“ç„¶è¿™æ ·åšå¾ˆéº»çƒ¦
'ğŒ†'.charCodeAt(0) // 55348
'ğŒ†'.charCodeAt(1) // 57094
String.fromCharCode(55348, 57094) // ğŒ†

/* è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ */

'ğŒ†'.codePointAt(0) // 119558

String.fromCodePoint(119558) // ğŒ†
```
å¦å¤–å­—ç¬¦ä¸²é‡Œçš„è½¬ä¹‰å†™æ³•ä¹Ÿå­˜åœ¨é—®é¢˜ï¼š
```js
'\u0061' // a
'\u1D306' // "á´°6"

/* è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ */

'\u{1D306}' // "ğŒ†"
```
æœ€åè¿˜æœ‰æ­£åˆ™è¡¨è¾¾å¼çš„ä¸€äº›å‘ï¼š
```js
/^.$/.test('ğŒ†') // false

/* è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ */

/^.$/u.test('ğŒ†') // true
```

## ç›¸å…³ç½‘ç«™
[Unicode å­—ç¬¦ç™¾ç§‘](https://unicode-table.com/cn/) å¯ä»¥æŸ¥è¯¢å­—ç¬¦ç›¸å¯¹åº”çš„ç¼–ç ã€‚  

[fileformat.info](https://www.fileformat.info/info/unicode/) å¯ä»¥æ›´è¿›ä¸€æ­¥çš„æŸ¥è¯¢ Unicode åˆ†å—ç­‰ä¿¡æ¯ã€‚

## å‚è€ƒ
[The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets (No Excuses!)](https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/)  

[Unicodeä¸JavaScriptè¯¦è§£](https://www.ruanyifeng.com/blog/2014/12/unicode.html)